{% extends 'base.html' %}
{% load url from future %}

{% block meta_tags %}
<meta property="og:title" content="UIConnect - {{ listing.name }}"/>
{% endblock %}

{% block content %}
  <div class="row">
    <div class="span12">
      <h1>{{listing.name}}</h1>
    </div>
  </div>
  <div class="span2">

    {% include 'user_side.html' with viewed_user=listing.user %}

    {% if user == listing.user or user.is_staff %}
    <div class="modal hide" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        <h3 id="myModalLabel">Are you sure you want to delete this item?</h3>
      </div>
      <div class="modal-body">
        <p>You will not be able to recover this item in future.</p>
      </div>
      <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        <a class="btn btn-danger" href="{% url 'listings:delete' listing.id %}">Yes, delete</a>
      </div>
    </div>

    {% endif %}
  </div>

  <div class="span10">
    {% include 'messages.html' %}

    <div class="pull-left">
      <div id="listingCarousel" class="carousel slide" data-interval="0" style="width: 300px; height: 430px;">
        <div class="carousel-inner" style="background-color: #ccc;">

          {% if listing.images.all %}
          {% for img in listing.images.all %}

          <div class="item{% if forloop.first %} active{% endif %}" style="text-align: center;">
            <a href="{{ img.image.url }}" rel="lightbox[thumbnails]" title="{{ img.caption }}"><img src="{{ img.formatted_image.url }}" alt="" /></a>
            <div class="carousel-caption" style="position: relative; margin-top: 0;">
              <p>{{img.caption}}</p>
            </div>
          </div>

          {% endfor %}
          {% else %}

          <div class="item active">
            <span class="default-thumbnail">{{ listing.name|slice:":4" }}</span>
            <div class="carousel-caption" style="position: relative; margin-top: 0;">
              <p>No images for this item.</p>
            </div>
          </div>

          {% endif %}

        </div>
        {% if listing.images.count > 1 %}
        <a class="left carousel-control" href="#listingCarousel" data-slide="prev">&lsaquo;</a>
        <a class="right carousel-control" href="#listingCarousel" data-slide="next">&rsaquo;</a>
        {% endif %}

        {% include 'social.html' %}

      </div><!-- end carousel -->
    </div>

    <div class="pull-left listing-info" style="width: 200px;">

      <div class="social" style="text-align: right;">
        <span style="margin-right: 20px;"><span id="span_likes">{{listing.likes.count}}</span> likes this item.</span>
        {% if user.is_authenticated %}
        <button id="btn_like" class="btn btn-small" style="margin-top: -5px;">
          {% if user in listing.likes.all %}
          <i class="icon-remove"></i> Unlike
          {% else %}
          <i class="icon-heart"></i> Like it
          {% endif %}
        </button>
        {% endif %}
      </div>

      <dl class="span7 dl-horizontal">
        <dt>Selling for</dt>
        <dd>USD {{listing.price}}</dd>

        <dt>Categories</dt>
        <dd>
        {% if listing.categories.all %}
        {% for c in listing.categories.all %}
          <span class="label">{{c.name}}</span>
        {% endfor %}
        {% else %}
          Not part of any collections.
        {% endif %}
        </dd>

        <dt>Collections</dt>
        <dd>
        {% if listing.collections.all %}
        {% for c in listing.collections.all %}
          <a class="label label-info" href="{% url 'collections:view' c.id %}">{{c.name}}</a>
        {% endfor %}
        {% else %}
          Not part of any collections.
        {% endif %}
        </dd>

        <dt>Description </dt>
        <dd>{{listing.description}}</dd>

        <dt>&nbsp;</dt>
        <dd>
        {% if listing in user.cart.added_listings %}
          Already in your shopping cart.
        {% else %}
          <form action="{% url 'cart:add' listing.id %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="quantity" value="1" />
            {% if listing.user != user %}
            <input type="submit" class="btn btn-large" href="{% url 'cart:add' listing.id %}" style="display: block;" value="Add to Cart" />
            {% endif %}
          </form>
        {% endif %}
        </dd>

      </dl>


    {% if user == listing.user %}
    <h5>Owner's menu</h5>

    <div class="btn-toolbar" style="margin-bottom: 30px;">
      <div class="btn-group">
        <a class="btn btn-danger" href="#" data-target="#myModal" data-toggle="modal"><i class="icon-trash"></i> Delete Item</a>
        <a class="btn" href="{% url 'listings:manage_images' listing.id %}"><i class="icon-camera"></i> Manage Images</a>
        <a class="btn" href="{% url 'listings:update' listing.id %}"><i class="icon-pencil"></i> Edit Item</a>
      </div>
    </div>
    {% endif %}

    </div>

    <div class="clearfix">&nbsp;</div>

    <div class="span8">
      <h4>Comments</h4>
      <div class="">
        <p class="bubble">Woo, love this!</p>
        <p>
          {% if listing.user.get_profile.avatar %}
          <img src="{{ listing.user.get_profile.avatar.url }}" width="32" style="margin-right: 10px;" />
          {% endif %}
          Victor commented 10 hours ago.
        </p>
      </div>
      <div class="clearfix">&nbsp;</div>

      <div class="">
        <p class="bubble-owner">Glad you liked it!</p>
        <p style="text-align: right;">
          {% if listing.user.get_profile.avatar %}
          <img src="{{ listing.user.get_profile.avatar.url }}" width="32" style="margin-right: 10px;" />
          {% endif %}
          (Item owner)<br />Victor commented 10 hours ago.
        </p>
      </div>
    </div>

  </div>
{% endblock %}

{% block js_footer %}
<script>
$(document).ready(function() {
  var likes = {{listing.likes.count}};

  $('#btn_like').click(function(){
    var text = $('#btn_like').html();
    var btn_text = '';
    if (text.indexOf("Unlike") == -1){
      likes += 1;
      btn_text = '<i class="icon-remove"></i> Unlike';
    }
    else{
      likes -= 1;
      btn_text = '<i class="icon-heart"></i> Like this';
    }

    $.get('{% url 'listings:like' listing.id %}', function(data) {
      console.log('Liked.');
    });

    $('#span_likes').html(likes);
    $('#btn_like').html(btn_text);
  });

});
</script>

{% include 'follow/follow_js.html' with viewed_user=listing.user %}
<script src="{{STATIC_URL}}js/lightbox.js"></script>
<link href="{{STATIC_URL}}css/lightbox.css" rel="stylesheet" />
{% endblock %}
